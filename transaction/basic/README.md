# 트랜잭션
## 개요
* 서비스에서 트랜잭션을 설정하기 위해 반드시 알아야할 내용을 정리하고 
* 코드를 통해 실제 사용해봄으로써 트랜잭션 동작을 이해하고자 한다.

## 트랜잭션 격리 수준 (isolation level)
| 격리 수준 (Isolation Level) | 특징                                     | 생길 수 있는 문제                                    | 적절한 상황                                            |
| ----------------------- | -------------------------------------- | --------------------------------------------- | ------------------------------------------------- |
| **READ UNCOMMITTED**    | 커밋되지 않은 다른 트랜잭션의 변경 사항도 읽을 수 있음        | Dirty Read, Non-Repeatable Read, Phantom Read | 거의 사용하지 않음. 임시 로그 수집, 비정형 통계 등 데이터 정합성이 중요하지 않을 때 |
| **READ COMMITTED**      | 커밋된 데이터만 읽을 수 있음. 대부분의 DB의 기본값         | Non-Repeatable Read, Phantom Read             | 일반적인 CRUD 업무, 성능과 일관성 사이에서 균형이 필요한 경우 (Oracle 등)  |
| **REPEATABLE READ**     | 동일 트랜잭션 내에서는 같은 데이터를 읽을 때 항상 동일한 결과 보장 | Phantom Read                                  | 재고 확인, 장바구니 등 반복 조회가 중요한 경우. (MySQL 기본 격리 수준)     |
| **SERIALIZABLE**        | 가장 높은 격리 수준. 트랜잭션 간 완전한 직렬화 수행         | 성능 저하, 잠금 경합                                  | 회계, 금융, 정산 등 일관성이 절대적으로 필요한 경우만 사용                |

## 트랜잭션 전파 (Propgation)
| 전파 방식 (`Propagation`) | 설명                               | 사용 예시                      |
| --------------------- | -------------------------------- | -------------------------- |
| **REQUIRED** *(기본값)*  | 현재 트랜잭션이 있으면 참여하고, 없으면 새로 생성     | 대부분의 서비스 메서드               |
| **REQUIRES\_NEW**     | 항상 **새 트랜잭션 시작**, 기존 트랜잭션은 일시 중단 | 로그 기록, 알림 발송 등 독립 트랜잭션 처리  |
| **SUPPORTS**          | 트랜잭션 있으면 참여, 없으면 비트랜잭션으로 실행      | 조회성 서비스 메서드                |
| **NOT\_SUPPORTED**    | 트랜잭션 **무시**하고 비트랜잭션으로 실행         | 캐시 조회, 트랜잭션이 필요 없는 메서드     |
| **NEVER**             | 트랜잭션이 **있으면 예외 발생**              | 트랜잭션을 사용하지 않아야 하는 곳 명시적 차단 |
| **MANDATORY**         | 반드시 트랜잭션 안에서 실행되어야 함. 없으면 예외     | 내부 메서드에서만 호출되도록 강제         |
| **NESTED**            | 내부 트랜잭션처럼 동작 (savepoint 이용)      | 롤백 범위 제한할 때 (주의: DB 지원 필요) |

### REQUIRES_NEW 와 REQUIRED
#### 흐름
  ```text
      createAndUpdateThenFail() @Transactional(REQUIRED)
            → create(10000) @Transactional(REQUIRES_NEW)
            → update(1L, 999) @Transactional(REQUIRED)
            → 예외 발생  
  ```
* REQUIRES_NEW인 create()는 **별도 트랜잭션(T2)**으로 실행되며 즉시 커밋됨.
* 이후 update()는 기존 트랜잭션(T1) 안에서 수행되므로, 예외 발생 시 함께 롤백됨.
* 최종적으로 create는 살아 있고, update는 롤백됨.
#### 결과
  ```text
    [계좌 생성] 시작
    [계좌 생성] 완료
    [UPDATE RESULT] 999
    [READ RESULT] 10000
  ```
